<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IMPACTA CRM</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="icon" type="image/x-icon" href="img/logo-mobile-2025">
  <link rel="icon" href="img/favicon-2025.png" type="image/png">
  <style>
    /* CORE VARIABLES */
    :root{
      --brand:#0c62ab; --brand-dark:#094a80; --ink:#0f172a; --muted:#64748b;
      --line:#e2e8f0; --bg:#f1f5f9; --radius:12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    
    body{ margin:0; font-family:var(--sans); color:var(--ink); background: var(--bg); line-height:1.5; font-size: 14px; 
      -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
    }
    input, textarea, select { user-select: text; -webkit-user-select: text; }
    a{color:var(--brand); text-decoration:none}
    .wrap{max-width:1800px; margin:0 auto; padding:0 24px}
    
    /* TOPBAR */
    .topbar{ position:sticky; top:0; z-index:50; border-bottom:1px solid var(--line); background:rgba(255,255,255,.98); backdrop-filter:blur(10px); }
    .topbar .inner{ display:flex; align-items:center; justify-content:space-between; gap:16px; padding:14px 0; }
    .brand{display:flex; align-items:center; gap:12px; min-width:260px;}
    .brand h1 { margin:0; font-size:20px; font-weight:800; color:var(--brand); line-height:1.1; letter-spacing: -0.02em; }
    .brand p { margin:0; font-size:12px; color:var(--muted); font-weight:500; }
    
    /* BUTTONS */
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 16px; border-radius:8px; border:1px solid rgba(12,98,171,.1); background:var(--brand); color:#fff; font-weight:600; font-size:14px; cursor:pointer; transition:all .15s ease; white-space:nowrap; }
    .btn:hover{background:var(--brand-dark)}
    .btn.secondary{background:#fff; color:var(--ink); border:1px solid var(--line);}
    .btn.secondary:hover{background:#f8fafc; border-color:#cbd5e1}
    .btn.danger{background:#fff; color:#b91c1c; border:1px solid rgba(185,28,28,.2);}
    .btn.danger:hover{background:#fef2f2; border-color:#b91c1c}
    .btn.success{background:#10b981; color:#fff; border-color:#059669;}
    .btn.success:hover{background:#059669;}
    .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:flex-end;}

    /* CARDS */
    .card{ background:var(--brand); color: #fff; border:1px solid var(--brand-dark); border-radius:var(--radius); box-shadow: 0 12px 30px -5px rgba(12, 98, 171, 0.25); overflow:hidden; display:flex; flex-direction:column; }
    .card .hd{ padding:16px 20px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.15); }
    .card .hd h2{margin:0; font-size:15px; font-weight:700; color:#fff;}
    .card .bd{padding:20px; flex:1;}
    
    input, select, textarea{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.4); background:#fff; color:var(--ink); outline:none; font-family:var(--sans); font-size:14px; }
    input:focus, select:focus, textarea:focus{ border-color: #fff; box-shadow:0 0 0 3px rgba(255,255,255,0.25); }
    
    .pill{ display:inline-block; padding:4px 8px; border-radius:6px; font-size:11px; font-weight:700; text-transform:uppercase; text-align: center; }
    .pill.stage{background:#e0f2fe; color:#0369a1;}
    .pill.industry{background:#f0fdf4; color:#15803d; margin-right:6px;}
    
    .tablewrap{ border:1px solid var(--line); border-radius:10px; background:#fff; margin-top:20px; color: var(--ink); width: 100%; overflow-x: auto; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:14px 12px; border-bottom:1px solid var(--line); font-size:13px; vertical-align:top; }
    th{ position:sticky; top:0; background:#f8fafc; text-align:left; font-size:11px; font-weight:700; text-transform:uppercase; color:var(--muted); cursor: pointer; white-space:nowrap; user-select: none; }
    th:hover { color: var(--brand); background:#f1f5f9; }
    th.sort-asc::after { content: " ‚ñ≤"; color: var(--brand); }
    th.sort-desc::after { content: " ‚ñº"; color: var(--brand); }

    td.lead-col { font-weight:600; color:var(--brand-dark); min-width: 180px; }
    .lead-meta {font-weight:400; color:var(--muted); font-size:12px; display:block;}
    
    .kpi{display:grid; grid-template-columns: repeat(4, 1fr); gap:12px;}
    .kpi .box{ border:1px solid var(--line); border-radius:10px; padding:14px; background:#fff; color: var(--ink); }
    .kpi .box .label{font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase;}
    .kpi .box .value{font-size:22px; font-weight:800; color:var(--ink); margin-top:4px}

    /* MODAL */
    .modal{ position:fixed; inset:0; background:rgba(15,23,42,.7); backdrop-filter:blur(4px); display:none; align-items:center; justify-content:center; padding:20px; z-index:100; user-select: text; -webkit-user-select: text; }
    .modal.open{display:flex}
    .modal .panel{ width:min(1200px, 95%); height: 90vh; background:#f8fafc; border-radius:16px; border: 1px solid var(--line); color: var(--ink); display: flex; flex-direction: column; overflow: hidden; }
    .modal .panel .hd{ padding:16px 24px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--line); background: #ffffff; }
    .modal .panel .hd h3{margin:0; font-size:16px; font-weight:700; color:var(--brand);}
    
    .status-bar { padding: 12px 24px; background: #eef2ff; border-bottom: 1px solid var(--line); display: flex; gap: 32px; align-items: center; }
    .status-group { display: flex; flex-direction: column; gap: 4px; flex: 1; }
    .status-label { font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--muted); }
    
    #m_stage { background: transparent; border: none; font-size: 18px; font-weight: 800; color: var(--brand); padding: 0; width: 100%; cursor: default; }
    #m_nextAction { background: #fff; border: 2px solid #10b981; color: #064e3b; font-weight: 600; padding:8px; border-radius:6px;}

    .bd-grid { display: grid; grid-template-columns: 1fr 1fr; flex: 1; overflow: hidden; }
    .modal-col { padding: 24px; overflow-y: auto; }
    .modal-col.left { border-right: 1px solid var(--line); }
    @media (max-width: 900px) { .bd-grid { grid-template-columns: 1fr; } .modal-col.left { border-right: none; border-bottom: 1px solid var(--line); } }

    .modal-grid label, .filters label { color: #0f172a; display:block; margin-bottom:4px; font-size:13px; font-weight:700; }
    .modal-grid input, .modal-grid select, .modal-grid textarea { border: 1px solid var(--line); background: #ffffff; color: var(--ink); margin-bottom:12px; width:100%; padding:8px; border-radius:6px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }

    .call-controls { background: #fff; border:1px solid var(--line); border-radius:12px; padding:16px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; }
    .timer { font-family:var(--mono); font-size:24px; font-weight:700; color:var(--brand); }
    .timer.active { color:#b91c1c; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%{opacity:1} 50%{opacity:0.6} 100%{opacity:1} }
    
    .quick-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .mini { padding:6px 10px; border-radius:6px; font-size:12px; font-weight:600; border:1px solid var(--line); background:#fff; cursor:pointer; }
    .mini:hover { border-color:var(--brand); color:var(--brand); }
    .mini.selected { background: var(--brand); color:#fff; border-color:var(--brand); }

    .modal .tablewrap { background: #ffffff; border: 1px solid var(--line); margin-top:0; }
    .modal .tablewrap th { background: #f1f5f9; color: var(--muted); }
    .modal .tablewrap td { background: #ffffff; }
    
    #historyModal .panel { width: min(900px, 95%); }
    #editModal .panel .hd { background: var(--brand); } 
    #editModal .panel .hd h3 { color: #fff; }
    #editModal .panel { height: auto; max-height:90vh; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap">
      <div class="inner">
        <div class="brand">
          <div style="width:32px; height:32px; background:var(--brand); border-radius:6px; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800;">I</div>
          <div>
            <h1>IMPACTA CRM</h1>
            <p id="userDisplay">Loading...</p>
          </div>
        </div>
        <div class="toolbar">
          <a href="https://calendar.app.google/3q9GSm3bkQSeTJjB7" target="_blank" class="btn secondary">Book Free 3-Point Diagnostic</a>
          <a href="bd_calling_playbook.html" target="_blank" class="btn secondary">Calling Playbook</a>
          <a href="key_industries.html" target="_blank" class="btn secondary">Key Industries Cheat Sheet</a>
          <button class="btn secondary" onclick="openHistory()">Call History</button>
          <button class="btn" id="btnCreateNew">+ New Lead</button>
          <div style="width:1px; height:24px; background:var(--line); margin:0 8px;"></div>
          <button class="btn secondary" onclick="logout()">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <main class="wrap">
    <section class="card">
      <div class="hd">
        <h2>My Leads</h2>
        <span class="hint mono" id="viewStatus">0 Leads</span>
      </div>
      <div class="bd">
        <div class="kpi" id="kpiGrid"></div>
        
        <div class="filters" style="display:flex; gap:12px; margin-top:20px; padding:15px; background:#fff; border-radius:10px; border:1px solid var(--line);">
          <div style="flex:1">
             <label>Search Leads</label>
             <input id="search" placeholder="Filter by name, company, or industry..." style="border-color:var(--line);">
          </div>
          <div style="min-width: 180px;">
              <label>Filter Industry</label>
              <select id="filterIndustry" style="border-color:var(--line);"><option value="">All Industries</option></select>
          </div>
          <div>
              <label>Due Date</label>
              <select id="filterDue" style="border-color:var(--line);">
                  <option value="today_past">Due Today & Past</option>
                  <option value="overdue">Overdue Only</option>
                  <option value="no_date">New Leads (No Date)</option> 
                  <option value="tomorrow">Tomorrow</option>
                  <option value="week">This Week</option>
                  <option value="all">All Dates</option>
              </select>
          </div>
          <div>
             <label>Filter Stage</label>
             <select id="filterStage" style="border-color:var(--line);"></select>
          </div>
        </div>

        <div class="tablewrap">
          <table id="leadTable">
            <thead>
              <tr>
                <th id="th_company" onclick="setSort('company')">Company / Lead</th>
                <th id="th_industry" onclick="setSort('industry')">Industry</th>
                <th id="th_phone" onclick="setSort('phone')">Phone</th>
                <th id="th_city" onclick="setSort('city')">City</th>
                <th id="th_gbp1" onclick="setSort('gbp1')">GBP 1</th>
                <th id="th_gbp2" onclick="setSort('gbp2')">GBP 2</th>
                <th id="th_gbp3" onclick="setSort('gbp3')">GBP 3</th>
                <th>Rec</th>
                <th id="th_stage" onclick="setSort('stage')">Stage</th>
                <th id="th_nextAction" onclick="setSort('nextAction')">Next Action</th>
                <th id="th_nextDue" onclick="setSort('nextDue')">Next Due</th>
                <th style="text-align:right">Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <div class="modal" id="modal">
    <div class="panel">
      <div class="hd">
        <h3 id="modalTitle">Work Lead</h3>
        <button class="btn secondary" id="btnCloseModal" style="color:var(--brand)">Close</button>
      </div>
      <div class="status-bar">
        <div class="status-group"><span class="status-label">Current Stage</span><input id="m_stage" readonly /></div>
        <div class="status-group">
            <span class="status-label">Set Next Action</span>
            <select id="m_nextAction">
                <option value="Call Attempt">Call Attempt</option>
                <option value="Follow-up Email">Follow-up Email</option>
                <option value="Book 15-min">Book 15-min</option>
                <option value="Confirm 15-min">Confirm 15-min</option>
                <option value="Sold 48-Hour Fix">Sold 48-Hour Fix</option>
                <option value="Sold Rev Diagnostic">Sold Rev Diagnostic</option>
                <option value="Sold PPA">Sold PPA</option>
                <option value="Reschedule">Reschedule</option>
                <option value="Nurture">Nurture</option>
                <option value="Disqualify">Disqualify</option>
                <option value="X - Disqualify">X - Disqualify</option>
                <option value="X - DNC">X - DNC</option>
                <option value="X - Bad Phone">X - Bad Phone</option>
            </select>
        </div>
      </div>
      <div class="bd-grid">
        <div class="modal-col left">
          <div class="row modal-grid"><div><label>Name</label><input id="m_name" readonly /></div><div><label>Title</label><input id="m_title" readonly /></div></div>
          <div class="row modal-grid"><div><label>Company</label><input id="m_company" readonly /></div><div><label>Industry</label><input id="m_industry" readonly /></div></div>
          <div class="row modal-grid"><div><label>Phone</label><input id="m_phone" readonly /></div><div><label>City</label><input id="m_city" readonly /></div></div>
          <div class="row modal-grid"><div><label>Email</label><input id="m_email" readonly /></div><div><label>Website</label><input id="m_website" readonly /></div></div>
          <div class="modal-grid"><label>Recommendation</label><textarea id="m_rec" readonly style="height:70px; resize:none;"></textarea></div>
          <div class="row modal-grid"><div><label>GBP 1</label><textarea id="m_gbp1" readonly style="height:80px; resize:none;"></textarea></div><div><label>GBP 2</label><textarea id="m_gbp2" readonly style="height:80px; resize:none;"></textarea></div></div>
          <div class="modal-grid"><label>GBP 3</label><textarea id="m_gbp3" readonly style="height:80px; resize:none;"></textarea></div>
          <div class="modal-grid"><label>Lead/Contact Notes</label><textarea id="m_notes" readonly style="height:100px"></textarea></div>
        </div>
        <div class="modal-col right">
          <div class="call-controls">
            <div id="callTimer" class="timer">00:00</div>
            <div style="display:flex; gap:10px;"><button class="btn success" id="btnCallStart">üìû Call</button><button class="btn danger" id="btnCallEnd" style="display:none;">End</button></div>
          </div>
          <div style="margin-top:20px;">
            <label style="font-size:12px; font-weight:700; color:var(--muted); text-transform:uppercase;">Select Call Outcome</label>
            <div class="quick-actions">
                <button class="mini" onclick="quickSet('Attempting','Call Attempt')">Attempted</button>
                <button class="mini" onclick="quickSet('Connected','Book 15-min')">Connected</button>
                <button class="mini" onclick="quickSet('Booked ‚Äì 15 Min Diagnostic','Confirm 15-min')">Booked 3-Point</button>
                <button class="mini" onclick="quickSet('Sold - 48 Hour Fix','Sold 48-Hour Fix')">Sold 48</button>
                <button class="mini" onclick="quickSet('Sold - RLD','Sold Rev Diagnostic')">Sold RLD</button>
                <button class="mini" onclick="quickSet('Sold - PPA','Sold PPA')">Sold PPA</button>
            </div>
            <div class="quick-actions" style="margin-top:8px;">
                <button class="mini" style="border-color:#ef4444; color:#b91c1c;" onclick="quickSet('Disqualified','X - Disqualify')">X Disqualify</button>
                <button class="mini" style="border-color:#ef4444; color:#b91c1c;" onclick="quickSet('Disqualified','X - DNC')">X DNC</button>
                <button class="mini" style="border-color:#ef4444; color:#b91c1c;" onclick="quickSet('Disqualified','X - Bad Phone')">X Bad Phone</button>
            </div>
          </div>
          <br>
          <div class="modal-grid" style="margin-top:10px"><label style="color:var(--ink)">Next Due</label><input id="m_nextDue" type="datetime-local" style="max-width: 180px;" /></div>
          <div class="modal-grid"><label style="color:var(--ink)">Call Notes</label><textarea id="logNote" placeholder="Result of call..."></textarea></div>
          <button class="btn" id="btnSaveLog" style="width:100%; margin-top:20px;">Save & Next</button>
          <div class="tablewrap" style="max-height:200px; overflow-y:auto; margin-top:20px;">
            <table><thead><tr><th>Date</th><th>Caller</th><th>Action</th><th>Note</th></tr></thead><tbody id="logTbody"></tbody></table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="editModal">
    <div class="panel" style="height:auto; max-height:90vh;">
        <div class="hd"><h3 id="editModalTitle">Edit Lead</h3><button class="btn secondary" onclick="document.getElementById('editModal').classList.remove('open')">Close</button></div>
        <div class="modal-col">
            <form id="editForm">
                <div class="row modal-grid"><div><label>First Name</label><input id="e_first" /></div><div><label>Last Name</label><input id="e_last" /></div></div>
                <div class="row modal-grid"><div><label>Title</label><input id="e_title" /></div><div><label>Industry</label><input id="e_industry" /></div></div>
                <div class="row modal-grid"><div><label>Company</label><input id="e_comp" /></div><div><label>Phone</label><input id="e_phone" /></div></div>
                <div class="row modal-grid"><div><label>City</label><input id="e_city" /></div><div><label>Email</label><input id="e_email" /></div></div>
                <div class="row modal-grid"><div><label>Website</label><input id="e_website" /></div><div><label>Recommendation</label><input id="e_recommendation" /></div></div>
                <div style="margin-top:20px; padding-top:16px; border-top:1px solid var(--line);">
                    <label style="color:var(--brand)">Diagnostic Data (GBP)</label>
                    <div class="row modal-grid"><div><label>GBP 1</label><input id="e_gbp1" /></div><div><label>GBP 2</label><input id="e_gbp2" /></div></div>
                    <div class="row modal-grid" style="margin-top:12px"><div><label>GBP 3</label><input id="e_gbp3" /></div></div>
                </div>
                <div class="modal-grid" style="margin-top:12px"><label>Initial Notes</label><textarea id="e_notes"></textarea></div>
                <button class="btn" type="submit" style="margin-top:15px;">Save Changes</button>
            </form>
        </div>
    </div>
  </div>

  <div class="modal" id="historyModal">
    <div class="panel">
        <div class="hd"><h3>Call History (Last 50)</h3><button class="btn secondary" onclick="document.getElementById('historyModal').classList.remove('open')">Close</button></div>
        <div class="bd" style="padding:0;"><div class="tablewrap" style="border:none; margin-top:0; border-radius:0;"><table style="margin-top:0;"><thead><tr><th>Date</th><th>Lead</th><th>Result</th><th>Note</th><th style="text-align:right">Action</th></tr></thead><tbody id="historyBody"></tbody></table></div></div>
    </div>
  </div>

<script>
let leads = [];
let filteredLeads = []; 
let activeLeadId = null;
let timerInt = null;
let seconds = 0;
let localUser = { name: "Local Agent" }; 

async function init() {
    const userStr = localStorage.getItem('currentUser');
    if (userStr) {
        localUser = JSON.parse(userStr);
        document.getElementById('userDisplay').textContent = localUser.name || localUser.email;
    } else {
        document.getElementById('userDisplay').textContent = "Local Agent Session";
    }
    
    const STAGES = ["New Lead", "Attempting", "Connected", "Booked ‚Äì 15 Min Diagnostic", "Sold - 48 Hour Fix", "Sold - RLD", "Sold - PPA", "Nurture"];
    const sel = document.getElementById('filterStage');
    sel.innerHTML = `<option value="">All Stages</option>` + STAGES.map(s=>`<option value="${s}">${s}</option>`).join('');
    
    document.getElementById('filterDue').onchange = render;
    document.getElementById('filterStage').onchange = render;
    document.getElementById('filterIndustry').onchange = render; 
    document.getElementById('search').oninput = render;

    document.getElementById('btnCloseModal').onclick = () => { document.getElementById('modal').classList.remove('open'); stopTimer(); };
    document.getElementById('btnCreateNew').onclick = openNewLeadModal;
    await fetchLeads();
}

async function fetchLeads() {
    try {
        const response = await fetch('/api/leads');
        const data = await response.json();
        leads = data.map(l => ({...l, id: l._id || l.id})); 

        const industryCounts = {};
        leads.forEach(l => {
            if(l.industry) {
                const ind = l.industry.trim();
                industryCounts[ind] = (industryCounts[ind] || 0) + 1;
            }
        });
        
        const indSelect = document.getElementById('filterIndustry');
        indSelect.innerHTML = `<option value="">All Industries</option>` + Object.keys(industryCounts).sort().map(i => `<option value="${i}">${i} (${industryCounts[i]})</option>`).join('');
        render();
    } catch (e) { console.error("Database connection failed:", e); }
}

function render() {
    const search = document.getElementById('search').value.toLowerCase();
    const filterStage = document.getElementById('filterStage').value;
    const filterInd = document.getElementById('filterIndustry').value;
    const filterDue = document.getElementById('filterDue').value;

    const now = new Date();
    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
    const tomorrowStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0);
    const tomorrowEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 23, 59, 59);
    const weekEnd = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

    filteredLeads = leads.filter(l => {
        const userId = localUser.uid || localUser.id; 
        if (localUser.role !== 'admin' && l.assignedTo !== userId) return false;
        if (l.stage === 'Disqualified') return false; 
        if (filterStage && l.stage !== filterStage) return false;
        if (filterInd && l.industry !== filterInd) return false;
        if (search && !JSON.stringify(l).toLowerCase().includes(search)) return false;

        if(filterDue && filterDue !== 'all') {
            let isValidDate = false; let d;
            if (l.nextDue) { d = new Date(l.nextDue); isValidDate = !isNaN(d.getTime()); }
            if (filterDue === 'no_date') return !isValidDate; 
            if(!isValidDate) return false; 
            
            if(filterDue === 'today_past') { if(d > todayEnd) return false; }
            else if(filterDue === 'overdue') { if(d >= now) return false; }
            else if(filterDue === 'tomorrow') { if(d < tomorrowStart || d > tomorrowEnd) return false; }
            else if(filterDue === 'week') { if(d < todayEnd || d > weekEnd) return false; }
        }
        return true;
    });

    document.getElementById('viewStatus').textContent = `${filteredLeads.length} Leads`;
    document.getElementById('kpiGrid').innerHTML = `
        <div class="box"><div class="label">Total</div><div class="value">${filteredLeads.length}</div></div>
        <div class="box"><div class="label">Booked</div><div class="value">${filteredLeads.filter(l => l.stage && l.stage.includes('Booked')).length}</div></div>
    `;

    document.getElementById('tbody').innerHTML = filteredLeads.map(l => `
        <tr>
            <td class="lead-col">${l.company || 'Unknown'}<span class="lead-meta">${l.firstName || ''} ${l.lastName || ''}</span></td>
            <td><span class="pill industry">${l.industry || '-'}</span></td>
            <td>${l.phone || '-'}</td>
            <td>${l.city || '-'}</td>
            <td>${l.gbp1 || '-'}</td>
            <td>${l.gbp2 || '-'}</td>
            <td>${l.gbp3 || '-'}</td>
            <td>${l.recommendation || '-'}</td>
            <td><span class="pill stage">${l.stage}</span></td>
            <td>${l.nextAction || '-'}</td>
            <td>${l.nextDue ? new Date(l.nextDue).toLocaleDateString() : '-'}</td>
            <td style="text-align:right; white-space:nowrap;">
                <button class="mini" style="background:#eff6ff; color:#0c62ab; border-color:#dbeafe;" onclick="generateDiagnostic('${l.id}')">üìä Report</button>
                <button class="mini" onclick="openWork('${l.id}')">Work</button>
                <button class="mini" onclick="openEdit('${l.id}')">Edit</button>
            </td>
        </tr>`).join('');
}

// --- DYNAMIC AI-STYLE DIAGNOSTIC GENERATOR ---
window.generateDiagnostic = (id) => {
    const l = leads.find(x => x.id === id);
    if (!l) return;

    // 1. Generate 5-Char Unique Reference Code
    const base = (l.company || 'CMP') + (l.phone || 'PHN') + (l.city || 'CTY');
    let hash = 0;
    for (let i = 0; i < base.length; i++) hash = Math.imul(31, hash) + base.charCodeAt(i) | 0;
    const code = Math.abs(hash).toString(36).toUpperCase().substring(0, 5).padStart(5, 'A');

    const today = new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    
    // 2. The Smart Parser: Converts "7/10 - Note" into descriptive consultant text
    const parseGbp = (text, category) => {
        const str = text || 'Pending analysis.';
        const match = str.match(/^(\d+(?:\.\d+)?)\/10\s*(?:-|-)?\s*(.*)/);
        let score = 'N/A', note = str, badge = 'warn', status = 'Reviewing', fix = 'Requires further evaluation.';
        
        if (match) {
            score = match[1]; note = match[2];
            const s = parseFloat(score);
            if (s >= 8) { badge = 'good'; status = 'Optimized'; }
            else if (s >= 5) { badge = 'warn'; status = 'Missed Opp'; }
            else { badge = 'bad'; status = 'Critical'; }
        }

        // Generate dynamic "Consultant" text based on category
        let findingText = '';
        if (category === 1) {
            findingText = `Analysis indicates: <strong>${note}</strong>. This currently limits your search visibility for specific, high-intent local queries compared to top competitors.`;
            fix = `Optimize profile attributes and categories to specifically address "${note}" and capture lost traffic.`;
        } else if (category === 2) {
            findingText = `Review velocity and trust signals show: <strong>${note}</strong>. This signals lower trust to potential new customers researching your brand.`;
            fix = `Standardize response protocols and visual proof to overcome "${note}" and boost click-through rates.`;
        } else {
            findingText = `Your speed-to-lead and routing reveal: <strong>${note}</strong>. You are actively losing leads during off-hours or peak contact times.`;
            fix = `Implement automated routing or text-back infrastructure to instantly plug the "${note}" lead leak.`;
        }

        return { score, note, badge, status, findingText, fix };
    };

    const g1 = parseGbp(l.gbp1, 1);
    const g2 = parseGbp(l.gbp2, 2);
    const g3 = parseGbp(l.gbp3, 3);
    
    // Calculate Average Health Score
    let t = 0, c = 0;
    [g1, g2, g3].forEach(g => { if(g.score !== 'N/A') { t += parseFloat(g.score); c++; } });
    const avgScore = c > 0 ? (t / c).toFixed(1) : 'N/A';
    const isBadHealth = c > 0 && (t / c) < 6;

    // Check Recommendation type for bottom CTA block
    const recText = l.recommendation || '';
    const is48 = recText.toLowerCase().includes('48');

    // 3. Dynamic Executive Summary
    let execSummary = `We audited <strong>${l.company || 'your business'}</strong>'s digital presence in ${l.city || 'your local area'}. `;
    if (parseFloat(avgScore) >= 7) {
        execSummary += `You are a market leader with strong brand authority. However, your sheer size has created subtle "Systems Leaks" regarding <strong>${g3.note.toLowerCase()}</strong> and <strong>${g2.note.toLowerCase()}</strong> that are likely bleeding high-intent leads to smaller, hungrier competitors.`;
    } else {
        execSummary += `While your reputation has potential, you are currently suffering from critical <strong>"Speed-to-Lead" and visibility leakage</strong>. Bottlenecks like <strong>${g3.note.toLowerCase()}</strong> are actively sending emergency leads directly to your competitors.`;
    }

    // 4. Construct the HTML
    const html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Free 3-Point GBP Diagnostic \u2014 ${l.company || 'Client'}</title>
    <style>
        :root { --brand: #0c62ab; --ink: #0f172a; --muted: #475569; --bg: #ffffff; --card: #f8fafc; --border: #e5e7eb; --good: #16a34a; --warn: #f59e0b; --bad: #dc2626; --radius: 14px; }
        * { box-sizing: border-box }
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--ink); line-height: 1.55; }
        a { color: var(--brand); text-decoration: none }
        .wrap { max-width: 900px; margin: 0 auto; padding: 20px; }
        .topbar { background: #fff; padding: 18px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .brandlogo { height: 40px; width: auto; }
        .pill { background: #eff6ff; border: 1px solid #dbeafe; color: var(--brand); padding: 6px 12px; border-radius: 999px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .grid { display: grid; grid-template-columns: 1.35fr .65fr; gap: 20px; margin-top: 30px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr } }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; margin-bottom: 20px; page-break-inside: avoid; }
        .card h2 { margin: 0 0 10px 0; font-size: 22px; color: var(--brand); }
        .card h3 { margin: 0 0 10px 0; font-size: 16px; font-weight: 700; text-transform: uppercase; color: var(--muted); }
        .kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px; }
        .kpi { background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
        .kpi .label { font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 700; }
        .kpi .value { font-size: 20px; font-weight: 900; margin-top: 4px; color: var(--brand); }
        .kpi .note { font-size: 11px; color: var(--muted); margin-top: 4px; line-height: 1.2; }
        table { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; font-size: 13px; }
        th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); text-align: left; vertical-align: top; }
        th { background: #f1f5f9; font-weight: 700; color: var(--muted); text-transform: uppercase; font-size: 11px; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; border: 1px solid transparent; }
        .badge.good { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .badge.warn { background: #ffedd5; color: #9a3412; border-color: #fed7aa; }
        .badge.bad { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .callout { margin-top: 16px; border-left: 4px solid var(--brand); background: #eff6ff; border-radius: 6px; padding: 16px; font-size: 14px; }
        .kv { display: grid; grid-template-columns: 100px 1fr; gap: 6px 12px; font-size: 13px; margin-top: 12px; }
        .kv .k { font-weight: 700; color: var(--muted); }
        .print-btn { background: var(--brand); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 700; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; font-size: 14px; }
        .print-btn:hover { opacity: 0.9; }
        .action-btn { background: var(--brand); color: white; padding: 8px 16px; border-radius: 6px; font-weight: 700; font-size: 12px; display: inline-block; text-decoration: none; transition: background 0.2s; }
        .action-btn:hover { background: #0a5596; }
        @media print {
            @page { margin: 0.5cm; size: portrait; }
            body { background: #fff; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print, .print-btn, .action-btn { display: none !important; }
            .wrap { max-width: 100%; padding: 0; }
            .card { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; }
            a { text-decoration: none; color: #000; }
        }
    </style>
</head>
<body>
    <div class="topbar">
        <img src="https://impactabusinesssolutions.com/img/logo-main-2025.png" alt="IMPACTA" class="brandlogo">
        <div class="no-print">
            <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print / Save as PDF</button>
        </div>
    </div>
    <main class="wrap">
        <div class="card" style="border-left: 5px solid var(--brand);">
            <div style="display:flex; justify-content:space-between; align-items:start;">
                <div>
                    <h1 style="margin:0; font-size:24px; color:var(--ink);">3-Point GBP Diagnostic</h1>
                    <p style="margin:4px 0 0; color:var(--muted); font-size:14px;">Prepared for: <strong>${l.company || 'Prospective Client'}</strong></p>
                </div>
                <div style="text-align:right;">
                    <span class="pill" style="display:block; margin-bottom:4px;">Ref: ${code}</span>
                    <span style="font-size:12px; color:var(--muted); font-weight:600;">${today}</span>
                </div>
            </div>
        </div>

        <section class="grid">
            <div class="card">
                <h2>Executive Summary</h2>
                <p style="font-size:14px; color:var(--muted); line-height:1.6;">${execSummary}</p>
                <div class="kpis">
                    <div class="kpi">
                        <div class="label">Health Score</div>
                        <div class="value">${avgScore} / 10</div>
                        <div class="note">${isBadHealth ? 'Requires attention' : 'Strong potential'}</div>
                    </div>
                    <div class="kpi">
                        <div class="label">Primary Leak</div>
                        <div class="value">${is48 ? 'Systems' : 'Conversion'}</div>
                        <div class="note">${is48 ? 'Missed opportunities' : 'Trust signals'}</div>
                    </div>
                    <div class="kpi">
                        <div class="label">Quick Win</div>
                        <div class="value">${is48 ? '48-Hour Fix' : 'Diagnostic'}</div>
                        <div class="note">See recommendation</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <h3>Business Snapshot</h3>
                <div class="kv">
                    <div class="k">Name</div><div class="v">${l.company || 'N/A'}</div>
                    <div class="k">Category</div><div class="v">${l.industry || 'N/A'}</div>
                    <div class="k">Location</div><div class="v">${l.city || 'N/A'}</div>
                    <div class="k">Phone</div><div class="v">${l.phone || 'N/A'}</div>
                    <div class="k">Status</div><div class="v"><span class="badge ${isBadHealth ? 'bad' : 'warn'}">${isBadHealth ? 'Action Required' : 'Leaking Revenue'}</span></div>
                </div>
            </div>
        </section>

        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                <h3>1. Relevance & Completeness</h3>
                <span class="badge ${g1.badge}">Score: ${g1.score}/10</span>
            </div>
            <table>
                <tr><th width="30%">Check</th><th width="20%">Status</th><th>Finding</th></tr>
                <tr>
                    <td><strong>Categories</strong></td>
                    <td><span class="badge ${g1.badge}">${g1.status}</span></td>
                    <td>${g1.findingText}</td>
                </tr>
            </table>
            <div class="callout"> <strong>üöÄ Fix:</strong> ${g1.fix} </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                <h3>2. Conversion Signals</h3>
                <span class="badge ${g2.badge}">Score: ${g2.score}/10</span>
            </div>
            <table>
                <tr><th width="30%">Check</th><th width="20%">Status</th><th>Finding</th></tr>
                <tr>
                    <td><strong>Trust Metrics</strong></td>
                    <td><span class="badge ${g2.badge}">${g2.status}</span></td>
                    <td>${g2.findingText}</td>
                </tr>
            </table>
            <div class="callout"> <strong>üöÄ Fix:</strong> ${g2.fix} </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                <h3>3. Lead Capture Systems</h3>
                <span class="badge ${g3.badge}">Score: ${g3.score}/10</span>
            </div>
            <table>
                <tr><th width="30%">Check</th><th width="20%">Status</th><th>Finding</th></tr>
                <tr>
                    <td><strong>Routing & Speed</strong></td>
                    <td><span class="badge ${g3.badge}">${g3.status}</span></td>
                    <td>${g3.findingText}</td>
                </tr>
            </table>
            <div class="callout"> <strong>üöÄ Fix:</strong> ${g3.fix} </div>
        </div>

        <div class="card" style="background:#f0f9ff; border:1px solid #bae6fd;">
            <h2>Recommended Next Step</h2>
            <p style="margin-bottom:16px;">Because the bottleneck is clearly centered around <strong>${is48 ? 'Speed-to-Lead' : 'systems and conversion leakage'}</strong>, we recommend the <strong>${is48 ? '48-Hour Fix' : 'Revenue Leak Diagnostic'}</strong>.</p>
            
            <div style="display:flex; gap:20px; align-items:center;">
                <div style="flex:1;">
                    <h4 style="margin:0; color:var(--brand);">${is48 ? '48-Hour Fix: The "Speed-to-Lead" System' : 'Revenue Leak Diagnostic'}</h4>
                    <ul style="font-size:13px; color:var(--muted); padding-left:20px; margin-top:8px;">
                        ${is48 ? `
                            <li><strong>Targeted Implementation:</strong> ${recText.replace('48hr Fix - ', '')}</li>
                            <li><strong>Missed Call Text-Back:</strong> Capture leads automatically 24/7.</li>
                            <li><strong>Instant Lead Alerts:</strong> Route web/chat leads directly to field phones.</li>
                        ` : `
                            <li><strong>Full "Mystery Shopper" test:</strong> Test your routing around "${g3.note}"</li>
                            <li><strong>Audit of lead hand-off speed:</strong> Identify the gap from Call to CRM.</li>
                            <li><strong>Actionable Blueprint:</strong> ${recText || 'Map out exactly how many leads rot over the weekend.'}</li>
                        `}
                    </ul>
                </div>
                <div style="text-align:right; min-width: 120px;">
                    <div style="font-size:24px; font-weight:900; color:var(--brand);">$350</div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom: 10px;">One-time Fee</div>
                    <a href="${is48 ? 'https://impactabusinesssolutions.com/48-hour-fix.html' : 'https://impactabusinesssolutions.com/revenue-diagnostic.html'}" class="action-btn" target="_blank">
                        ${is48 ? 'Install the Fix &rarr;' : 'Diagnose the Leak &rarr;'}
                    </a>
                </div>
            </div>
        </div>

        <div style="text-align:center; font-size:11px; color:var(--muted); margin-top:20px;">
            &copy; ${new Date().getFullYear()} IMPACTA Business Solutions &bull; Generated for ${l.company || 'Prospective Client'}
        </div>
    </main>
</body>
</html>`;

    const win = window.open('', '_blank');
    if (win) {
        win.document.write(html);
        win.document.close();
    } else {
        alert("Please allow pop-ups to generate the diagnostic report.");
    }
};

window.openWork = (id) => {
    activeLeadId = id;
    const l = leads.find(x => x.id === id);
    
    document.getElementById('m_company').value = l.company || '';
    document.getElementById('m_name').value = `${l.firstName || ''} ${l.lastName || ''}`;
    document.getElementById('m_industry').value = l.industry || '';
    document.getElementById('m_phone').value = l.phone || '';
    document.getElementById('m_stage').value = l.stage || 'New Lead';
    document.getElementById('m_gbp1').value = l.gbp1 || '';
    document.getElementById('m_gbp2').value = l.gbp2 || '';
    document.getElementById('m_gbp3').value = l.gbp3 || '';
    document.getElementById('m_rec').value = l.recommendation || '';
    document.getElementById('m_notes').value = l.notes || '';
    
    let d = l.nextDue ? new Date(l.nextDue) : new Date();
    const offset = d.getTimezoneOffset() * 60000;
    const localISOTime = (new Date(d - offset)).toISOString().slice(0, 16);
    document.getElementById('m_nextDue').value = localISOTime;

    document.getElementById('modal').classList.add('open');
    document.getElementById('callTimer').textContent = '00:00';
    seconds = 0;
    stopTimer();
    loadHistory(id);
};

window.openNewLeadModal = () => {
    activeLeadId = null; 
    document.getElementById('editForm').reset();
    document.getElementById('editModalTitle').textContent = "Create New Lead"; 
    document.getElementById('editModal').classList.add('open');
};

window.openEdit = (id) => {
    activeLeadId = id;
    const l = leads.find(x => x.id === id);
    
    document.getElementById('e_first').value = l.firstName || '';
    document.getElementById('e_last').value = l.lastName || '';
    document.getElementById('e_title').value = l.title || '';
    document.getElementById('e_industry').value = l.industry || '';
    document.getElementById('e_comp').value = l.company || '';
    document.getElementById('e_phone').value = l.phone || '';
    document.getElementById('e_email').value = l.email || '';
    document.getElementById('e_city').value = l.city || '';
    document.getElementById('e_website').value = l.website || '';
    document.getElementById('e_recommendation').value = l.recommendation || '';
    document.getElementById('e_gbp1').value = l.gbp1 || '';
    document.getElementById('e_gbp2').value = l.gbp2 || '';
    document.getElementById('e_gbp3').value = l.gbp3 || '';
    document.getElementById('e_notes').value = l.notes || '';
    
    document.getElementById('editModalTitle').textContent = "Edit Lead"; 
    document.getElementById('editModal').classList.add('open');
};

document.getElementById('editForm').onsubmit = async (e) => {
    e.preventDefault();
    const payload = {
        firstName: document.getElementById('e_first').value,
        lastName: document.getElementById('e_last').value,
        company: document.getElementById('e_comp').value,
        phone: document.getElementById('e_phone').value,
        email: document.getElementById('e_email').value,
        city: document.getElementById('e_city').value,
        industry: document.getElementById('e_industry').value,
        website: document.getElementById('e_website').value,
        recommendation: document.getElementById('e_recommendation').value,
        gbp1: document.getElementById('e_gbp1').value,
        gbp2: document.getElementById('e_gbp2').value,
        gbp3: document.getElementById('e_gbp3').value,
        notes: document.getElementById('e_notes').value,
        stage: 'New Lead'
    };

    try {
        const method = activeLeadId ? 'PUT' : 'POST';
        const url = activeLeadId ? `/api/leads/${activeLeadId}` : '/api/leads';

        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            alert(activeLeadId ? 'Lead Updated!' : 'New Lead Created!');
            document.getElementById('editModal').classList.remove('open');
            fetchLeads(); 
        }
    } catch (error) {
        console.error("Save failed:", error);
        alert("Error saving lead to local server.");
    }
};

window.startTimer = () => {
    if(timerInt) return;
    const phone = document.getElementById('m_phone').value;
    if(phone) {
        const cleanPhone = phone.replace(/[^\d+]/g, '');
        const dialer = document.createElement('a');
        dialer.href = `tel:${cleanPhone}`;
        document.body.appendChild(dialer);
        dialer.click();
        document.body.removeChild(dialer);
    }
    document.getElementById('btnCallStart').style.display = 'none';
    document.getElementById('btnCallEnd').style.display = 'block';
    document.getElementById('callTimer').classList.add('active');
    seconds = 0;
    timerInt = setInterval(() => {
        seconds++;
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        document.getElementById('callTimer').textContent = `${m}:${s}`;
    }, 1000);
};

window.stopTimer = () => {
    clearInterval(timerInt);
    timerInt = null;
    document.getElementById('callTimer').classList.remove('active');
    document.getElementById('btnCallStart').style.display = 'block';
    document.getElementById('btnCallEnd').style.display = 'none';
};

document.getElementById('btnCallStart').onclick = startTimer;

document.getElementById('btnCallEnd').onclick = () => {
    stopTimer();
    const dur = document.getElementById('callTimer').textContent;
    if (dur !== "00:00") {
        const noteBox = document.getElementById('logNote');
        noteBox.value = `[Call: ${dur}] ` + noteBox.value;
    }
};

window.quickSet = (stage, nextAction) => {
    document.getElementById('m_stage').value = stage;
    document.getElementById('m_nextAction').value = nextAction;
    
    document.querySelectorAll('.quick-actions .mini').forEach(b => b.classList.remove('selected'));
    event.target.classList.add('selected');
    
    const dueInput = document.getElementById('m_nextDue');
    const now = new Date();
    
    if (stage.includes('Disqualified')) {
        dueInput.value = ''; 
    } else if (nextAction.includes('15-min')) {
        now.setDate(now.getDate() + 1); 
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        dueInput.value = now.toISOString().slice(0,16);
    } else {
        now.setHours(now.getHours() + 4); 
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        dueInput.value = now.toISOString().slice(0,16);
    }
};

document.getElementById('btnSaveLog').onclick = async () => {
    if(!activeLeadId) return;

    let stage = document.getElementById('m_stage').value;
    const nextAct = document.getElementById('m_nextAction').value;
    const nextDueVal = document.getElementById('m_nextDue').value;
    const note = document.getElementById('logNote').value;
    const currentLead = leads.find(l => l.id === activeLeadId);

    let dueUpdated = false;
    const newDueTime = nextDueVal ? new Date(nextDueVal).getTime() : 0;
    const oldDueTime = currentLead.nextDue ? new Date(currentLead.nextDue).getTime() : 0;
    if (Math.abs(newDueTime - oldDueTime) > 60000) dueUpdated = true;

    const userTypedNote = note.replace(/^\[Call:\s\d{2}:\d{2}\]\s*/, '').trim();

    if (seconds > 10) {
         if(!dueUpdated) { alert("‚ö†Ô∏è CALL REQUIREMENT: Duration > 10s.\n\nYou must update the Next Due date."); return; }
         if(nextAct === 'Call Attempt' && !userTypedNote) { alert("‚ö†Ô∏è CALL REQUIREMENT: Duration > 10s.\n\nYou must either:\n1. Select a new Outcome\nOR\n2. Add a Note."); return; }
    }
    if (nextAct !== 'Call Attempt' && !dueUpdated && !nextAct.startsWith('X')) { alert("‚ö†Ô∏è QUALITY WARNING: You selected a new outcome but did not update the Next Due Date.\n\nWhen did you book the next step for?"); return; }
    if (nextAct === 'Call Attempt' && dueUpdated && !userTypedNote) { alert("‚ö†Ô∏è QUALITY WARNING: You changed the date but left the Outcome as 'Call Attempt'.\n\nPlease select a clearer outcome (e.g., Nurture, Reschedule) or clarify in notes."); return; }
    if (nextAct.startsWith('X') && !userTypedNote) { alert("‚ö†Ô∏è CRITICAL: You are disqualifying a lead. You MUST add a note explaining why."); return; }
    if (nextAct !== 'Call Attempt' && !userTypedNote) { alert("‚ö†Ô∏è QUALITY WARNING: Outcome selected but no note added.\n\nPlease type a brief result of the interaction."); return; }

    if (nextAct.startsWith('X')) stage = 'Disqualified';

    const btn = document.getElementById('btnSaveLog');
    btn.textContent = 'Saving...';
    btn.disabled = true;

    const updatedLead = { stage: stage, nextAction: nextAct, nextDue: nextDueVal || null };
    const logEntry = { leadId: activeLeadId, action: nextAct, note: note, caller: localUser.name, duration: document.getElementById('callTimer').textContent, createdAt: new Date().toISOString() };

    try {
        await fetch(`/api/leads/${activeLeadId}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(updatedLead) });
        await fetch('/api/activities', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(logEntry) });

        document.getElementById('logNote').value = '';
        document.querySelectorAll('.quick-actions .mini').forEach(b => b.classList.remove('selected'));
        stopTimer();
        document.getElementById('callTimer').textContent = '00:00'; 
        document.getElementById('modal').classList.remove('open');
        await fetchLeads();
    } catch (err) {
        console.error("Failed to save log", err);
        alert("Failed to save. Check server connection.");
    } finally {
        btn.textContent = 'Save & Next';
        btn.disabled = false;
    }
};

window.loadHistory = async (leadId) => {
    try {
        const res = await fetch(`/api/activities/${leadId}`);
        if(res.ok) {
            const logs = await res.json();
            document.getElementById('logTbody').innerHTML = logs.map(log => `
                <tr>
                    <td style="font-size:11px;">${new Date(log.createdAt).toLocaleString()}</td>
                    <td><span style="font-weight:600">${log.caller}</span></td>
                    <td>${log.action}</td>
                    <td>${log.note || '-'}</td>
                </tr>
            `).join('');
        }
    } catch(e) {
        console.error("Error loading history", e);
    }
};

function logout() { 
    localStorage.removeItem('currentUser');
    window.location.href = 'index.html'; 
}

init();
</script>
</body>
</html>